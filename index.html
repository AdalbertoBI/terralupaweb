<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lupa Terra Web - C√¢mera com Filtros</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Aplicativo de c√¢mera com zoom, filtros e controles avan√ßados">
    <meta name="theme-color" content="#ffe600">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lupa Terra">
    <meta name="msapplication-TileColor" content="#181c20">
    <meta name="msapplication-TileImage" content="./icon-144x144.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./icon-152x152.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="./icon-96x96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="./icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icon-192x192.png">
    <link rel="apple-touch-icon" sizes="384x384" href="./icon-384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./icon-512x512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="./icon-72x72.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icon-72x72.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <!-- Banner de Instala√ß√£o PWA Melhorado -->
    <div id="installBanner" class="install-banner" style="display: none;">
        <div class="install-content">
            <img src="./icon-72x72.png" alt="Lupa Terra" class="install-icon">
            <div class="install-text">
                <strong>Instalar Lupa Terra</strong>
                <p>Adicione √† tela inicial para acesso r√°pido</p>
            </div>
            <div class="install-buttons">
                <button id="installBtn" class="install-btn-primary">Instalar</button>
                <button id="dismissBtn" class="install-btn-secondary">Agora n√£o</button>
            </div>
        </div>
    </div>

    <!-- Banner para iOS -->
    <div id="iosBanner" class="ios-banner" style="display: none;">
        <div class="ios-content">
            <img src="./icon-72x72.png" alt="Lupa Terra" class="install-icon">
            <div class="ios-text">
                <strong>Instalar Lupa Terra</strong>
                <p>Toque em <span class="ios-share">‚éô</span> e depois em "Adicionar √† Tela de In√≠cio"</p>
            </div>
            <button id="iosDismissBtn" class="install-btn-secondary">Entendi</button>
        </div>
    </div>

    <header>
        <img src="./logo.jpg" alt="Terra Eletr√¥nica" class="logo">
        <span class="brand">LUPA TERRA WEB</span>
    </header>

    <div id="videoContainer">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="glCanvas"></canvas>
    </div>

    <!-- Controles de Zoom -->
    <div id="zoomGroup" class="fab fab-top-left">
        <button id="zoomIn">‚ñ≤</button>
        <span id="zoomValue">1</span>
        <button id="zoomOut">‚ñº</button>
    </div>

    <!-- Controles de Brilho -->
    <div id="brightnessGroup" class="fab fab-bottom-left">
        <button id="brightnessUp">‚ñ≤</button>
        <span id="brightnessValue">1</span>
        <button id="brightnessDown">‚ñº</button>
    </div>

    <!-- Controles de Filtro -->
    <div id="colorGroup" class="fab fab-top-right">
        <button id="colorPrev">‚óÄÔ∏è</button>
        <span id="colorValue">normal</span>
        <button id="colorNext">‚ñ∂Ô∏è</button>
    </div>

    <!-- Bot√£o Central da C√¢mera -->
    <div id="actionsGroup" class="fab fab-center">
        <button id="cameraBtn">üì∑</button>
        <select id="cameraSelect" style="display: none;"></select>
    </div>

    <!-- Bot√£o Menu -->
    <div class="fab fab-bottom-right">
        <button id="redBtn">Menu</button>
    </div>

    <!-- Menu Popup -->
    <div id="secondMenu" class="menu-popup">
        <button id="secondFreeze">‚ùÑÔ∏è Congelar</button>
        <button id="secondSave">üíæ Salvar</button>
        <button id="infoBtn">‚ÑπÔ∏è Info</button>
        <button id="resetBtn">‚Ü∫ Reset</button>
        <button id="flashBtn">üî¶ Lanterna</button>
        <button id="muteBtn">üîá Mute</button>
        <button id="fpsBtn">‚ÑπÔ∏è FPS</button>
    </div>

    <script src="./filters.js"></script>
    <script src="./script.js"></script>
    <script>
        // PWA Installation Logic Melhorado
        let deferredPrompt;
        let isInstallable = false;
        const installBanner = document.getElementById('installBanner');
        const iosBanner = document.getElementById('iosBanner');
        const installBtn = document.getElementById('installBtn');
        const dismissBtn = document.getElementById('dismissBtn');
        const iosDismissBtn = document.getElementById('iosDismissBtn');

        // Fun√ß√£o para detectar iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        // Fun√ß√£o para detectar se est√° em modo standalone (j√° instalado)
        function isStandalone() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        // Detectar evento de instala√ß√£o
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt disparado');
            e.preventDefault();
            deferredPrompt = e;
            isInstallable = true;
            
            // Mostrar banner ap√≥s 2 segundos se n√£o foi dispensado
            setTimeout(() => {
                if (!localStorage.getItem('pwa-dismissed') && !isStandalone()) {
                    installBanner.style.display = 'block';
                    console.log('Banner de instala√ß√£o mostrado');
                }
            }, 2000);
        });

        // Mostrar banner iOS se aplic√°vel
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (isIOS() && !isStandalone() && !localStorage.getItem('ios-dismissed')) {
                    iosBanner.style.display = 'block';
                    console.log('Banner iOS mostrado');
                }
            }, 3000);
        });

        // Bot√£o de instala√ß√£o
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                console.log('Iniciando instala√ß√£o...');
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                console.log('Resultado da instala√ß√£o:', outcome);
                
                if (outcome === 'accepted') {
                    console.log('PWA instalada com sucesso');
                }
                
                deferredPrompt = null;
                installBanner.style.display = 'none';
            }
        });

        // Bot√£o de dispensar
        dismissBtn.addEventListener('click', () => {
            installBanner.style.display = 'none';
            localStorage.setItem('pwa-dismissed', 'true');
            console.log('Banner dispensado');
        });

        // Bot√£o de dispensar iOS
        iosDismissBtn.addEventListener('click', () => {
            iosBanner.style.display = 'none';
            localStorage.setItem('ios-dismissed', 'true');
        });

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                        
                        // Verificar atualiza√ß√µes
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('Nova vers√£o dispon√≠vel');
                                    if (confirm('Nova vers√£o dispon√≠vel! Recarregar?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao registrar Service Worker:', error);
                    });
            });
        }

        // Detectar quando o app foi instalado
        window.addEventListener('appinstalled', () => {
            console.log('PWA foi instalada');
            installBanner.style.display = 'none';
            iosBanner.style.display = 'none';
        });

        // For√ßar mostrar banner para teste (remover em produ√ß√£o)
        setTimeout(() => {
            if (!isInstallable && !isStandalone() && !localStorage.getItem('pwa-dismissed')) {
                console.log('For√ßando exibi√ß√£o do banner para teste');
                installBanner.style.display = 'block';
            }
        }, 5000);
    </script>
</body>
</html>
